<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­ NFC æƒæå™¨</title>
    <style>
        :root { --primary: #2563eb; --error: #dc2626; --success: #16a34a; }
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f8fafc; color: #1e293b; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        h1 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--primary); }
        .status-box { padding: 10px; border-radius: 8px; margin-bottom: 1rem; font-weight: bold; text-align: center; }
        .idle { background: #e2e8f0; }
        .scanning { background: #dbeafe; color: var(--primary); animation: pulse 2s infinite; }
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: opacity 0.2s; background: var(--primary); color: white; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }
        #log { margin-top: 1.5rem; padding: 10px; background: #1e293b; color: #34d399; border-radius: 8px; font-family: monospace; font-size: 0.85rem; height: 200px; overflow-y: auto; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>Web NFC æƒæå™¨</h1>
    <div id="status" class="status-box idle">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹</div>
    
    <div class="btn-group">
        <button id="btnScan">é–‹å§‹æƒæ</button>
        <button id="btnWrite" style="background: #64748b;">å¯«å…¥æ¸¬è©¦</button>
    </div>

    <div id="log">--- ç³»çµ±æ—¥èªŒ ---</div>
</div>

<script>
    const btnScan = document.getElementById('btnScan');
    const btnWrite = document.getElementById('btnWrite');
    const statusBox = document.getElementById('status');
    const logElement = document.getElementById('log');

    function log(msg, isError = false) {
        const time = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.style.color = isError ? '#f87171' : '#34d399';
        line.textContent = `[${time}] ${msg}`;
        logElement.prepend(line);
    }

    // 1. ç’°å¢ƒæª¢æŸ¥
    if (!('NDEFReader' in window)) {
        statusBox.innerText = "âŒ ä¸æ”¯æ´ Web NFC";
        statusBox.style.color = "red";
        btnScan.disabled = btnWrite.disabled = true;
        log("éŒ¯èª¤ï¼šè«‹ä½¿ç”¨ Android Chrome ç€è¦½å™¨ä¸¦ç¢ºä¿åœ¨ HTTPS ç’°å¢ƒä¸‹", true);
    }

    // 2. å„ªåŒ–è®€å–é‚è¼¯
    btnScan.onclick = async () => {
        try {
            const ndef = new NDEFReader();
            // è«‹æ±‚æ¬Šé™ä¸¦å•Ÿå‹•æƒæ
            await ndef.scan();
            
            statusBox.innerText = "ğŸ” é è¿‘ NFC æ¨™ç±¤ä¸­...";
            statusBox.className = "status-box scanning";
            log("æƒæå™¨å·²å•Ÿå‹•...");

            ndef.onreadingerror = () => {
                log("è®€å–å¤±æ•—ï¼šç„¡æ³•è§£ææ¨™ç±¤ã€‚è«‹ç¢ºä¿æ¨™ç±¤æœªæå£æˆ–æœªåŠ å¯†ã€‚", true);
            };

            ndef.onreading = ({ message, serialNumber }) => {
                log(`âœ… åµæ¸¬åˆ°æ¨™ç±¤ï¼åºè™Ÿ: ${serialNumber}`);
                
                // è§£æè³‡æ–™å…§å®¹
                for (const record of message.records) {
                    let decodedData = "";
                    if (record.recordType === "text") {
                        const textDecoder = new TextDecoder(record.encoding);
                        decodedData = textDecoder.decode(record.data);
                    } else if (record.recordType === "url") {
                        const textDecoder = new TextDecoder();
                        decodedData = textDecoder.decode(record.data);
                    } else {
                        decodedData = `(éæ–‡å­—æ ¼å¼è³‡æ–™: ${record.recordType})`;
                    }
                    log(`å…§å®¹ [${record.recordType}]: ${decodedData}`);
                }
            };

        } catch (error) {
            log(`å•Ÿå‹•å¤±æ•—: ${error.name}`, true);
            if (error.name === "NotAllowedError") {
                log("æç¤ºï¼šä½¿ç”¨è€…æ‹’çµ•äº† NFC æ¬Šé™ã€‚", true);
            } else if (error.name === "NotSupportedError") {
                log("æç¤ºï¼šæœ¬è£ç½®æ²’æœ‰ NFC ç¡¬é«”æˆ–å·²é—œé–‰ã€‚", true);
            }
            statusBox.innerText = "å•Ÿå‹•å¤±æ•—";
            statusBox.className = "status-box idle";
        }
    };

    // 3. å¯«å…¥ç¯„ä¾‹
    btnWrite.onclick = async () => {
        try {
            const ndef = new NDEFReader();
            statusBox.innerText = "âœï¸ è«‹é è¿‘æ¨™ç±¤é€²è¡Œå¯«å…¥...";
            await ndef.write("Hello from GitHub Pages!");
            log("âœ… æˆåŠŸå°‡è³‡æ–™å¯«å…¥æ¨™ç±¤ï¼");
            statusBox.innerText = "å¯«å…¥æˆåŠŸ";
            setTimeout(() => { statusBox.innerText = "é»æ“ŠæŒ‰éˆ•é–‹å§‹"; }, 2000);
        } catch (error) {
            log(`å¯«å…¥å¤±æ•—: ${error}`, true);
        }
    };
</script>

</body>
</html>