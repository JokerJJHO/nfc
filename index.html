<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC é»åç³»çµ± V260222-1537</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f1f5f9; --error: #dc2626; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; width: 100%; max-width: 400px; border-radius: 15px; padding: 25px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .status-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 10px; font-weight: bold; }
        .can-write { background: #dcfce7; color: #166534; }
        .read-only { background: #fee2e2; color: #991b1b; }
        .syncing { background: #dbeafe; color: #1e40af; }
        
        #log { background: #1e293b; color: #34d399; padding: 15px; border-radius: 10px; font-family: monospace; font-size: 13px; height: 150px; overflow-y: auto; margin-top: 20px; border: 1px solid #334155; }
        button { width: 100%; padding: 16px; border: none; border-radius: 12px; background: var(--primary); color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        button:disabled { background: #94a3b8; }
        
        .info-row { margin: 15px 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }
        .label { font-size: 13px; color: #64748b; margin-bottom: 4px; }
        .value { font-size: 20px; font-weight: bold; color: #1e293b; word-break: break-all; }
        .student-name { color: var(--success); font-size: 24px; }
    </style>
</head>
<body>

<div class="card">
    <div id="writeStatus" class="status-tag">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    <h2>NFC é»åæƒæå™¨</h2>
    
    <div class="info-row">
        <div class="label">å­¸ç”Ÿå§“å</div>
        <div id="displayName" class="value student-name">ç­‰å¾…æƒæ...</div>
    </div>

    <div class="info-row">
        <div class="label">åµæ¸¬å¡è™Ÿ (NFC ID)</div>
        <div id="nfcID" class="value">----</div>
    </div>

    <button id="btnScan" disabled>è¼‰å…¥åå–®ä¸­...</button>

    <div id="log">æ­£åœ¨å¾é›²ç«¯åŒæ­¥å­¸ç”Ÿåå–®...</div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycby-YiIaVsSUXyaaYYyb43lRiXiwbIEPJWyaFGZZaHIvejUCXIsiqZ52dIJfi7wUPPTw/exec'; 
    
    let studentMap = new Map(); // ç”¨ä¾†å­˜æ”¾ NFC ID èˆ‡ å§“åçš„å°æ‡‰
    const btnScan = document.getElementById('btnScan');
    const logDiv = document.getElementById('log');
    const nfcIDDisplay = document.getElementById('nfcID');
    const nameDisplay = document.getElementById('displayName');
    const writeStatus = document.getElementById('writeStatus');

    function addLog(msg, isError = false) {
        const time = new Date().toLocaleTimeString([], { hour12: false });
        const div = document.createElement('div');
        if (isError) div.style.color = "#f87171";
        div.textContent = `[${time}] ${msg}`;
        logDiv.prepend(div);
    }

    // 1. é é¢é–‹å•Ÿæ™‚è‡ªå‹•ä¸‹è¼‰å­¸ç”Ÿåå–®
    async function fetchStudents() {
        try {
            const response = await fetch(scriptURL);
            const data = await response.json();
            
            if (data.students) {
                data.students.forEach(s => {
                    if (s.nfcId) studentMap.set(s.nfcId.toLowerCase().trim(), s.name);
                });
                addLog(`âœ… å·²åŒæ­¥ ${studentMap.size} ä½å­¸ç”Ÿåå–®`);
                btnScan.disabled = false;
                btnScan.innerText = "å•Ÿå‹•æƒæå™¨";
                writeStatus.innerText = "åå–®å·²å°±ç·’";
                writeStatus.className = "status-tag can-write";
            }
        } catch (e) {
            addLog("âŒ ç„¡æ³•å–å¾—å­¸ç”Ÿåå–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯", true);
            console.error(e);
        }
    }

    fetchStudents();

    btnScan.onclick = async () => {
        if (!('NDEFReader' in window)) {
            alert("ç€è¦½å™¨ä¸æ”¯æ´ Web NFC");
            return;
        }

        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            addLog("ğŸ“¡ æƒæå™¨ç›£è½ä¸­...");
            btnScan.innerText = "è«‹æ„Ÿæ‡‰å¡ç‰‡";
            btnScan.style.background = "#64748b";

            ndef.onreading = async ({ serialNumber }) => {
                const id = serialNumber.toLowerCase().trim();
                nfcIDDisplay.innerText = serialNumber;
                
                // æ¯”å°æœ¬åœ°åå–®é¡¯ç¤ºå§“å
                const name = studentMap.get(id) || "æœªçŸ¥è¨ªå®¢ (æœªè¨»å†Š)";
                nameDisplay.innerText = name;
                
                addLog(`ğŸ“‡ æƒæ: ${name} (${serialNumber})`);

                // åŒæ­¥è‡³ Google Sheets
                try {
                    fetch(scriptURL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ serialNumber: serialNumber }),
                    });
                    addLog("ğŸ“¤ å·²ç™¼é€è‡³é»åçµ±è¨ˆ");
                } catch (e) {
                    addLog("âŒ ç™¼é€å¤±æ•—", true);
                }
            };

        } catch (error) {
            addLog("ğŸš« å•Ÿå‹•å¤±æ•—: " + error, true);
        }
    };
</script>

</body>
</html>