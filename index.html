<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC 點名同步系統</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f1f5f9; }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; width: 100%; max-width: 400px; border-radius: 15px; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .status-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; margin-bottom: 10px; }
        .can-write { background: #dcfce7; color: #166534; }
        .read-only { background: #fee2e2; color: #991b1b; }
        #log { background: #1e293b; color: #34d399; padding: 15px; border-radius: 10px; font-family: monospace; font-size: 13px; height: 150px; overflow-y: auto; margin-top: 20px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; background: var(--primary); color: white; font-size: 16px; font-weight: bold; cursor: pointer; }
        .info-row { margin: 15px 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }
        .label { font-size: 12px; color: #64748b; }
        .value { font-size: 18px; font-weight: bold; color: #1e293b; word-break: break-all; }
    </style>
</head>
<body>

<div class="card">
    <div id="writeStatus" class="status-tag" style="display:none;"></div>
    <h2>NFC 點名掃描</h2>
    
    <div class="info-row">
        <div class="label">目前偵測卡號 (NFC ID)</div>
        <div id="nfcID" class="value">等待掃描...</div>
    </div>

    <button id="btnScan">啟動掃描器</button>

    <div id="log">系統準備就緒...</div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzLgpKLVR7NOPCBpxehE69kDTJXvP7L5TPCAVHAs8Kdf_sUnDNkuQ9rXbhJESjJxu77/exec'; // <--- 請貼入剛才部署的 GAS 網址
    const btnScan = document.getElementById('btnScan');
    const logDiv = document.getElementById('log');
    const nfcIDDisplay = document.getElementById('nfcID');
    const writeStatus = document.getElementById('writeStatus');

    function addLog(msg) {
        const div = document.createElement('div');
        div.textContent = `> ${msg}`;
        logDiv.prepend(div);
    }

    btnScan.onclick = async () => {
        if (!('NDEFReader' in window)) {
            alert("此瀏覽器不支援 NFC");
            return;
        }

        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            addLog("掃描器啟動，請靠近卡片...");
            btnScan.innerText = "正在監聽 NFC...";
            btnScan.style.background = "#64748b";

            ndef.onreading = async ({ serialNumber, message }) => {
                nfcIDDisplay.innerText = serialNumber;
                
                // 1. 檢測寫入能力 (簡單判斷：若能抓到訊息且沒報錯通常可寫，或嘗試觸發寫入檢查)
                // 注意：Web NFC 目前沒有直接的 isWritable 屬性，但能讀取到 NDEF 格式通常代表可寫
                writeStatus.style.display = "inline-block";
                writeStatus.innerText = "NDEF 格式卡片";
                writeStatus.className = "status-tag can-write";

                addLog(`讀取成功: ${serialNumber}`);

                // 2. 自動寫入 Google Sheets
                addLog("同步至試算表...");
                try {
                    const response = await fetch(scriptURL, {
                        method: 'POST',
                        body: JSON.stringify({ serialNumber: serialNumber }),
                    });
                    addLog("✅ 雲端同步完成");
                } catch (e) {
                    addLog("❌ 同步失敗，請檢查網路");
                }
            };

            ndef.onreadingerror = () => {
                addLog("讀取錯誤，這可能是一張加密卡(如悠遊卡)，僅能讀取序號", true);
                writeStatus.innerText = "唯讀或加密卡";
                writeStatus.className = "status-tag read-only";
            };

        } catch (error) {
            addLog("啟動失敗: " + error);
        }
    };
</script>

</body>
</html>